{
  "version": "2.0.0",
  "lastUpdated": "2024-08-29T12:42:00Z",
  "description": "Microsoft 365 Phishing Protection detection rules enhanced with CyberDrain phishing detection logic for identifying phishing attempts targeting Microsoft 365 login pages",
  "trusted_origins": [
    "https://login.microsoftonline.com",
    "https://login.microsoft.com",
    "https://login.windows.net",
    "https://login.microsoftonline.us",
    "https://login.partner.microsoftonline.cn",
    "https://login.live.com"
  ],
  "aad_detection_elements": [
    {
      "id": "loginfmt_field",
      "selectors": ["input[name='loginfmt']", "#i0116"],
      "description": "Azure AD username/email input field",
      "weight": 30
    },
    {
      "id": "next_button",
      "selectors": ["#idSIButton9"],
      "description": "Azure AD Next/Sign in button",
      "weight": 25
    },
    {
      "id": "password_field",
      "selectors": ["input[type='password']"],
      "description": "Password input field",
      "weight": 20
    },
    {
      "id": "microsoft_branding",
      "text_patterns": ["Microsoft\\s*365", "Office\\s*365", "Entra\\s*ID", "Azure\\s*AD", "Microsoft"],
      "description": "Microsoft branding text",
      "weight": 15
    }
  ],
  "required_elements": [
    {
      "id": "idPartnerPL",
      "selectors": ["input[name='idPartnerPL']", "[name*='idPartnerPL']", "[id*='idPartnerPL']"],
      "description": "Microsoft partner login field",
      "weight": 20
    },
    {
      "id": "urlMsaSignUp",
      "text_patterns": ["urlMsaSignUp"],
      "description": "Microsoft signup URL reference",
      "weight": 15
    },
    {
      "id": "flowToken",
      "text_patterns": ["flowToken"],
      "description": "Microsoft authentication flow token",
      "weight": 15
    },
    {
      "id": "aadcdn_msauth",
      "text_patterns": ["https://aadcdn\\.msauth\\.net/"],
      "description": "Microsoft authentication CDN reference",
      "weight": 15
    }
  ],
  "rules": [
    {
      "id": "check_legitimate_domain",
      "type": "url",
      "weight": 25,
      "condition": {
        "domains": [
          "login.microsoftonline.com"
        ]
      },
      "description": "Verify legitimate Microsoft domain (must be login.microsoftonline.com)"
    },
    {
      "id": "check_form_post_url",
      "type": "form_action",
      "weight": 30,
      "condition": {
        "contains": "login.microsoftonline.com",
        "form_selector": "form[action]"
      },
      "description": "Form POST URL must be login.microsoftonline.com for legitimate pages"
    },
    {
      "id": "detect_idpartnerpl_field",
      "type": "dom",
      "weight": 20,
      "condition": {
        "selectors": [
          "input[name='idPartnerPL']",
          "[name*='idPartnerPL']",
          "[id*='idPartnerPL']"
        ]
      },
      "description": "Detect presence of idPartnerPL field"
    },
    {
      "id": "detect_url_msa_signup",
      "type": "content",
      "weight": 15,
      "condition": {
        "contains": "urlMsaSignUp",
        "search_context": "page_source"
      },
      "description": "Detect urlMsaSignUp presence in page code"
    },
    {
      "id": "detect_aadcdn_msauth",
      "type": "content",
      "weight": 15,
      "condition": {
        "contains": "https://aadcdn.msauth.net/",
        "search_context": "page_source"
      },
      "description": "Detect aadcdn.msauth.net presence in source"
    },
    {
      "id": "check_loginfmt_field",
      "type": "dom",
      "weight": 20,
      "condition": {
        "selectors": [
          "input[name='loginfmt']",
          "#i0116"
        ]
      },
      "description": "Check for loginfmt input field availability"
    },
    {
      "id": "detect_flow_token",
      "type": "content",
      "weight": 15,
      "condition": {
        "contains": "flowToken",
        "search_context": "page_source"
      },
      "description": "Detect flowToken presence in page"
    },
    {
      "id": "verify_customcss_source",
      "type": "network",
      "weight": 25,
      "condition": {
        "network_pattern": "*customcss*",
        "required_domain": "https://aadcdn.msftauthimages.net/"
      },
      "description": "Custom CSS files must originate from aadcdn.msftauthimages.net"
    },
    {
      "id": "check_beginauth_csp",
      "type": "header",
      "weight": 30,
      "condition": {
        "header_name": "content-security-policy-report-only",
        "required_domains": [
          "https://*.msauth.net/",
          "https://*.msftauth.net/",
          "https://*.msftauthimages.net/",
          "https://*.msauthimages.net/",
          "https://*.msidentity.com/",
          "https://*.microsoftonline-p.com/",
          "https://*.microsoftazuread-sso.com/",
          "https://*.azureedge.net/",
          "https://*.outlook.com/",
          "https://*.office.com/",
          "https://*.office365.com/",
          "https://*.microsoft.com/",
          "https://*.bing.com/"
        ]
      },
      "description": "BeginAuth request must contain proper content-security-policy-report-only header"
    },
    {
      "id": "check_valid_referrer",
      "type": "header",
      "weight": 25,
      "condition": {
        "header_name": "referer",
        "allowed_referrers": [
          "https://login.microsoftonline.com",
          "https://login.microsoft.net",
          "https://login.microsoft.com",
          "https://autologon.microsoftazuread-sso.com",
          "https://tasks.office.com",
          "https://login.windows.net",
          "https://planner.cloud.microsoft"
        ]
      },
      "description": "Validate referrer against custom allow list of valid Microsoft referrers"
    }
  ],
  "thresholds": {
    "legitimate": 90,
    "suspicious": 60,
    "phishing": 30
  },
  "phishing_indicators": [
    {
      "id": "phi_001",
      "pattern": "(?:secure-?(?:microsoft|office|365|outlook))",
      "flags": "i",
      "severity": "high",
      "description": "Suspicious domain mimicking Microsoft services",
      "action": "block",
      "category": "domain_spoofing",
      "confidence": 0.9
    },
    {
      "id": "phi_001_enhanced",
      "pattern": "(?:secure-?(?:microsoft|office|365|outlook)|microsoft-?(?:secure|login|auth)|office-?(?:secure|login|auth)|365-?(?:secure|login|auth))",
      "flags": "i",
      "severity": "critical",
      "description": "Enhanced detection of domains mimicking Microsoft services with security/login keywords",
      "action": "block",
      "category": "domain_spoofing",
      "confidence": 0.95
    },
    {
      "id": "phi_002",
      "pattern": "(?:microsoft|office|365).*(?:security|verification|account).*(?:team|department|support)",
      "flags": "i",
      "severity": "high",
      "description": "Impersonation of Microsoft security team",
      "action": "block",
      "category": "brand_impersonation",
      "confidence": 0.85
    },
    {
      "id": "phi_003",
      "pattern": "(?:verify.*account|suspended.*365|update.*office|secure.*microsoft)",
      "flags": "i",
      "severity": "medium",
      "description": "Common Microsoft 365 phishing keywords",
      "action": "warn",
      "category": "social_engineering",
      "confidence": 0.7
    },
    {
      "id": "phi_004",
      "pattern": "(?:urgent.*(?:action|update|verify)|immediate.*(?:action|attention)|act.*(?:now|immediately)).*(?:microsoft|office|365)",
      "flags": "i",
      "severity": "medium",
      "description": "Urgency tactics targeting Microsoft users",
      "action": "warn",
      "category": "social_engineering",
      "confidence": 0.65
    },
    {
      "id": "phi_005",
      "pattern": "data:text/html.*(?:microsoft|office|365|outlook).*(?:login|password|signin)",
      "flags": "i",
      "severity": "critical",
      "description": "Data URI containing Microsoft login form",
      "action": "block",
      "category": "credential_harvesting",
      "confidence": 0.95
    },
    {
      "id": "phi_006",
      "pattern": "form.*action.*(?!login\\.microsoftonline\\.com)",
      "flags": "i",
      "severity": "high",
      "description": "Form POST URL not pointing to login.microsoftonline.com",
      "action": "warn",
      "category": "credential_harvesting",
      "confidence": 0.8
    },
    {
      "id": "phi_007",
      "pattern": "\\*customcss.*(?!aadcdn\\.msftauthimages\\.net)",
      "flags": "i",
      "severity": "high",
      "description": "Custom CSS loaded from non-authorized domain",
      "action": "block",
      "category": "resource_hijacking",
      "confidence": 0.85
    },
    {
      "id": "phi_008",
      "pattern": "content-security-policy-report-only.*(?!.*msauth\\.net|.*msftauth\\.net|.*msftauthimages\\.net|.*msauthimages\\.net|.*msidentity\\.com|.*microsoftonline-p\\.com|.*microsoftazuread-sso\\.com|.*azureedge\\.net|.*outlook\\.com|.*office\\.com|.*office365\\.com|.*microsoft\\.com|.*bing\\.com)",
      "flags": "i",
      "severity": "critical",
      "description": "Missing required CSP domains in BeginAuth request",
      "action": "block",
      "category": "header_manipulation",
      "confidence": 0.9
    },
    {
      "id": "phi_009",
      "pattern": "referer.*(?!login\\.microsoftonline\\.com|login\\.microsoft\\.net|login\\.microsoft\\.com|autologon\\.microsoftazuread-sso\\.com|tasks\\.office\\.com|login\\.windows\\.net|planner\\.cloud\\.microsoft)",
      "flags": "i",
      "severity": "high",
      "description": "Invalid referrer not in custom allow list",
      "action": "warn",
      "category": "referrer_spoofing",
      "confidence": 0.85
    },
    {
      "id": "phi_010_aad_fingerprint",
      "pattern": "(?=.*(?:loginfmt|i0116))(?=.*(?:idSIButton9|sign.*in|next))(?!.*login\\.microsoftonline\\.com)",
      "flags": "i",
      "severity": "critical",
      "description": "AAD-like login interface detected on non-Microsoft domain",
      "action": "block",
      "category": "interface_spoofing",
      "confidence": 0.98
    },
    {
      "id": "phi_011_missing_elements",
      "pattern": "(?=.*(?:microsoft|office|365))(?=.*(?:login|sign.*in))(?!.*(?:idPartnerPL|urlMsaSignUp|flowToken))",
      "flags": "i",
      "severity": "high",
      "description": "Microsoft branding without required authentication elements",
      "action": "warn",
      "category": "incomplete_spoofing",
      "confidence": 0.85
    },
    {
      "id": "phi_012_suspicious_resources",
      "pattern": "(?=.*customcss)(?!.*aadcdn\\.msftauthimages\\.net)",
      "flags": "i",
      "severity": "high",
      "description": "Custom CSS loaded from unauthorized domain",
      "action": "block",
      "category": "resource_hijacking",
      "confidence": 0.9
    },
    {
      "id": "phi_013_form_action_mismatch",
      "pattern": "(?=.*(?:microsoft|office|365))(?=.*(?:password|passwd))(?=.*action=)(?!.*login\\.microsoftonline\\.com)",
      "flags": "i",
      "severity": "critical",
      "description": "Microsoft-branded password form with non-Microsoft action URL",
      "action": "block",
      "category": "credential_harvesting",
      "confidence": 0.95
    }
  ],
  "legitimate_patterns": [
    {
      "id": "leg_001",
      "pattern": "login\\.microsoftonline\\.com",
      "description": "Official Microsoft Online login domain",
      "confidence": 1.0
    },
    {
      "id": "leg_002",
      "element_selectors": [
        "input[name='loginfmt']",
        "input[name='passwd']",
        "input[name='idPartnerPL']"
      ],
      "description": "Legitimate Microsoft login form elements including idPartnerPL",
      "confidence": 0.8
    },
    {
      "id": "leg_003",
      "content_patterns": [
        "urlMsaSignUp",
        "flowToken",
        "https://aadcdn.msauth.net/"
      ],
      "description": "Legitimate Microsoft authentication code patterns",
      "confidence": 0.85
    },
    {
      "id": "leg_004",
      "resource_patterns": [
        "https://aadcdn.msftauthimages.net/.*customcss.*"
      ],
      "description": "Legitimate source for custom CSS resources",
      "confidence": 0.9
    },
    {
      "id": "leg_005",
      "csp_domains": [
        "https://*.msauth.net/",
        "https://*.msftauth.net/",
        "https://*.msftauthimages.net/",
        "https://*.msauthimages.net/",
        "https://*.msidentity.com/",
        "https://*.microsoftonline-p.com/",
        "https://*.microsoftazuread-sso.com/",
        "https://*.azureedge.net/",
        "https://*.outlook.com/",
        "https://*.office.com/",
        "https://*.office365.com/",
        "https://*.microsoft.com/",
        "https://*.bing.com/"
      ],
      "description": "Required domains in content-security-policy-report-only header",
      "confidence": 1.0
    },
    {
      "id": "leg_006",
      "referrer_patterns": [
        "https://login\\.microsoftonline\\.com",
        "https://login\\.microsoft\\.net",
        "https://login\\.microsoft\\.com",
        "https://autologon\\.microsoftazuread-sso\\.com",
        "https://tasks\\.office\\.com",
        "https://login\\.windows\\.net",
        "https://planner\\.cloud\\.microsoft"
      ],
      "description": "Valid Microsoft referrers from custom allow list",
      "confidence": 0.95
    }
  ],
  "suspicious_behaviors": [
    {
      "id": "sus_001",
      "behavior": "password_field_without_microsoft_domain",
      "description": "Password field on non-Microsoft domain with Microsoft branding",
      "severity": "high",
      "action": "warn"
    },
    {
      "id": "sus_002",
      "behavior": "microsoft_keywords_on_suspicious_domain",
      "description": "Microsoft-related keywords on suspicious domain",
      "severity": "medium",
      "action": "monitor"
    },
    {
      "id": "sus_003",
      "behavior": "form_submit_to_external_domain",
      "description": "Login form submitting to non-Microsoft domain",
      "severity": "critical",
      "action": "block"
    },
    {
      "id": "sus_004",
      "behavior": "missing_idpartnerpl_field",
      "description": "Microsoft login page missing idPartnerPL field",
      "severity": "medium",
      "action": "warn"
    },
    {
      "id": "sus_005",
      "behavior": "missing_urlmsasignup",
      "description": "Missing urlMsaSignUp in page source code",
      "severity": "medium",
      "action": "warn"
    },
    {
      "id": "sus_006",
      "behavior": "missing_aadcdn_msauth",
      "description": "Missing https://aadcdn.msauth.net/ reference in source",
      "severity": "medium",
      "action": "warn"
    },
    {
      "id": "sus_007",
      "behavior": "missing_loginfmt_field",
      "description": "Missing loginfmt input field",
      "severity": "high",
      "action": "warn"
    },
    {
      "id": "sus_008",
      "behavior": "missing_flow_token",
      "description": "Missing flowToken in page source",
      "severity": "medium",
      "action": "warn"
    },
    {
      "id": "sus_009",
      "behavior": "customcss_wrong_source",
      "description": "Custom CSS loaded from unauthorized domain (not aadcdn.msftauthimages.net)",
      "severity": "high",
      "action": "block"
    },
    {
      "id": "sus_010",
      "behavior": "invalid_csp_header",
      "description": "BeginAuth request missing proper content-security-policy-report-only header",
      "severity": "critical",
      "action": "block"
    },
    {
      "id": "sus_011",
      "behavior": "invalid_referrer",
      "description": "Request contains referrer not in custom allow list",
      "severity": "high",
      "action": "warn"
    }
  ],
  "whitelist_domains": [
    "*.microsoft.com",
    "*.microsoftonline.com",
    "*.office.com",
    "*.office365.com",
    "*.live.com",
    "*.msauth.net",
    "*.msftauth.net",
    "*.msftauthimages.net",
    "*.msauthimages.net",
    "*.msidentity.com",
    "*.microsoftonline-p.com",
    "*.microsoftazuread-sso.com",
    "*.azureedge.net",
    "*.outlook.com",
    "*.bing.com"
  ],
  "valid_referrers": {
    "description": "Custom allow list of valid Microsoft referrers for authentication flows",
    "referrers": [
      "https://login.microsoftonline.com",
      "https://login.microsoft.net",
      "https://login.microsoft.com",
      "https://autologon.microsoftazuread-sso.com",
      "https://tasks.office.com",
      "https://login.windows.net",
      "https://planner.cloud.microsoft"
    ],
    "enforcement": "strict",
    "allow_missing_referrer": false,
    "case_sensitive": false
  },
  "detection_settings": {
    "enable_real_time_scanning": true,
    "enable_form_monitoring": true,
    "enable_url_verification": true,
    "enable_content_analysis": true,
    "enable_verification_badge": false,
    "verification_badge_domains": [
      "login.microsoftonline.com",
      "portal.office.com"
    ],
    "block_threshold": 0.7,
    "warn_threshold": 0.5,
    "monitor_threshold": 0.3,
    "aad_detection_threshold": 2,
    "required_elements_threshold": 3,
    "monitoring_timeout": 20000
  },
  "detection_logic": {
    "aad_fingerprint_rules": [
      {
        "id": "aad_basic",
        "condition": "hasLoginFmt AND hasNextBtn",
        "description": "Basic AAD interface detection",
        "weight": 50
      },
      {
        "id": "aad_branded",
        "condition": "brandingHit AND (hasLoginFmt OR hasPw)",
        "description": "Microsoft branding with login elements",
        "weight": 45
      }
    ],
    "trigger_rules": [
      {
        "id": "untrusted_aad_like",
        "condition": "aadLike AND NOT isTrustedOrigin",
        "action": "flag_phishy",
        "severity": "critical",
        "description": "AAD-like interface on untrusted domain"
      },
      {
        "id": "bad_form_action",
        "condition": "requireAction AND actionCheck.fail",
        "action": "flag_phishy",
        "severity": "high",
        "description": "Form action not pointing to Microsoft"
      },
      {
        "id": "bad_resources",
        "condition": "strictAudit AND resourceAudit.nonMicrosoftCount > 0",
        "action": "flag_phishy",
        "severity": "medium",
        "description": "Non-Microsoft resources detected"
      }
    ],
    "form_validation_rules": [
      {
        "id": "require_microsoft_action",
        "condition": "hasPasswordField AND NOT isTrustedFormAction",
        "action": "block_form",
        "description": "Password form must submit to Microsoft domain"
      }
    ],
    "resource_validation_rules": [
      {
        "id": "validate_css_origin",
        "pattern": "customcss",
        "required_origins": ["aadcdn.msftauthimages.net"],
        "action": "block",
        "description": "Custom CSS must come from Microsoft CDN"
      }
    ]
  },
  "configuration": {
    "enable_cryptographic_verification": true,
    "verification_endpoint": "https://365branding.com/api/verify-badge",
    "rules_update_endpoint": "https://api.m365security.com/rules/latest",
    "reporting_endpoint": "https://api.m365security.com/reports/phishing",
    "enable_reporting": true,
    "cache_results": true,
    "cache_ttl": 300000,
    "max_analysis_time": 3000,
    "enable_context_analysis": true,
    "context_window_size": 500,
    "cyberdrain_integration": {
      "enable_aad_fingerprinting": true,
      "enable_real_time_monitoring": true,
      "monitoring_timeout": 20000,
      "enable_credential_blocking": true,
      "enable_form_submission_blocking": true,
      "enable_valid_badge_display": true,
      "enable_phishing_banner": true,
      "strict_resource_audit": true,
      "require_microsoft_action": true
    }
  },
  "rules_metadata": {
    "total_rules": 25,
    "categories": [
      "domain_spoofing",
      "brand_impersonation",
      "social_engineering",
      "credential_harvesting",
      "suspicious_behavior",
      "resource_hijacking",
      "header_manipulation",
      "referrer_spoofing",
      "interface_spoofing",
      "incomplete_spoofing"
    ],
    "severity_levels": [
      "low",
      "medium",
      "high",
      "critical"
    ],
    "actions": [
      "monitor",
      "warn",
      "block"
    ],
    "confidence_range": [
      0.0,
      1.0
    ],
    "update_frequency": "daily",
    "source": "Microsoft 365 Security Research Team + CyberDrain Enhanced Detection",
    "cyberdrain_integration": {
      "version": "2.0.0",
      "features": [
        "Real-time AAD fingerprinting",
        "Dynamic content monitoring",
        "Form action validation",
        "Credential input blocking",
        "Trusted badge display",
        "Enhanced phishing detection"
      ],
      "detection_methods": [
        "DOM element analysis",
        "Resource origin auditing",
        "Form submission blocking",
        "Referrer validation",
        "CSP header validation"
      ]
    }
  }
}