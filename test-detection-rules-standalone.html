<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberShield Detection Rules - Standalone Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            color: #003049;
            margin-bottom: 15px;
        }
        .test-case {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #F77F00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #E56F00;
        }
        .status-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
        }
        .extension-connected {
            background: #d4edda;
            color: #155724;
        }
        .extension-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .summary {
            background: #003049;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="statusBanner" class="status-banner extension-disconnected">
        üîç Standalone Mode - Testing Detection Rules Logic (Extension Not Required)
    </div>

    <div class="container" style="margin-top: 60px;">
        <h1>CyberShield Detection Rules - Standalone Test</h1>
        <p>This page tests the detection rules logic without requiring the browser extension. Results show how the rules would behave when properly integrated.</p>

        <div class="test-grid">
            <!-- URL Analysis Tests -->
            <div class="test-section">
                <h3>üåê URL Analysis Tests</h3>
                <div class="test-case">
                    <h4>Legitimate Microsoft URLs</h4>
                    <button onclick="testURLs('legitimate')">Test Legitimate URLs</button>
                    <div id="url-legitimate-result" class="test-result" style="display: none;"></div>
                </div>
                <div class="test-case">
                    <h4>Phishing URLs</h4>
                    <button onclick="testURLs('phishing')">Test Phishing URLs</button>
                    <div id="url-phishing-result" class="test-result" style="display: none;"></div>
                </div>
            </div>

            <!-- Content Analysis Tests -->
            <div class="test-section">
                <h3>üìÑ Content Analysis Tests</h3>
                <div class="test-case">
                    <h4>Required Elements Detection</h4>
                    <button onclick="testContentAnalysis()">Test Content Elements</button>
                    <div id="content-result" class="test-result" style="display: none;"></div>
                </div>
            </div>

            <!-- Form Analysis Tests -->
            <div class="test-section">
                <h3>üìù Form Analysis Tests</h3>
                <div class="test-case">
                    <h4>Microsoft Login Form</h4>
                    <button onclick="testFormAnalysis()">Test Form Elements</button>
                    <div id="form-result" class="test-result" style="display: none;"></div>
                </div>
            </div>

            <!-- Referrer Validation Tests -->
            <div class="test-section">
                <h3>üîó Referrer Validation Tests</h3>
                <div class="test-case">
                    <h4>Valid vs Invalid Referrers</h4>
                    <button onclick="testReferrerValidation()">Test Referrers</button>
                    <div id="referrer-result" class="test-result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Comprehensive Test -->
        <div class="test-section">
            <h3>üß™ Comprehensive Rule Engine Test</h3>
            <div class="test-case">
                <h4>Complete Detection Engine Simulation</h4>
                <button onclick="runComprehensiveTest()" style="background: #003049; font-size: 16px; padding: 15px 30px;">Run All Tests</button>
                <div id="comprehensive-result" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Test Summary -->
        <div id="test-summary" class="summary" style="display: none;">
            <h3>üìä Test Results Summary</h3>
            <div id="summary-content"></div>
        </div>
    </div>

    <script>
        // Simulated detection rules (based on your actual rules)
        const detectionRules = {
            rules: [
                {
                    id: "check_legitimate_domain",
                    type: "url",
                    condition: { domains: ["login.microsoftonline.com"] },
                    description: "Verify legitimate Microsoft domain"
                },
                {
                    id: "detect_idpartnerpl_field",
                    type: "dom",
                    condition: { selectors: ["input[name='idPartnerPL']"] },
                    description: "Detect presence of idPartnerPL field"
                },
                {
                    id: "check_loginfmt_field",
                    type: "dom", 
                    condition: { selectors: ["input[name='loginfmt']"] },
                    description: "Check for loginfmt input field"
                }
            ],
            phishing_indicators: [
                {
                    id: "phi_001",
                    pattern: "(?:secure-?(?:microsoft|office|365|outlook))",
                    description: "Suspicious domain mimicking Microsoft services"
                }
            ],
            valid_referrers: {
                referrers: [
                    "https://login.microsoftonline.com",
                    "https://login.microsoft.net",
                    "https://login.microsoft.com",
                    "https://autologon.microsoftazuread-sso.com",
                    "https://tasks.office.com",
                    "https://login.windows.net",
                    "https://planner.cloud.microsoft"
                ]
            }
        };

        let testResults = [];

        // Simulated detection engine
        class SimulatedDetectionEngine {
            static analyzeURL(url) {
                const analysis = {
                    url,
                    isLegitimate: false,
                    threat_level: 'none',
                    findings: []
                };

                // Check legitimate domains
                const legitimateDomains = detectionRules.rules
                    .find(r => r.id === 'check_legitimate_domain')?.condition.domains || [];
                
                for (const domain of legitimateDomains) {
                    if (url.includes(domain)) {
                        analysis.isLegitimate = true;
                        analysis.findings.push(`Legitimate domain detected: ${domain}`);
                        break;
                    }
                }

                // Check phishing indicators
                for (const indicator of detectionRules.phishing_indicators) {
                    const regex = new RegExp(indicator.pattern, 'i');
                    if (regex.test(url)) {
                        analysis.threat_level = 'high';
                        analysis.isLegitimate = false;
                        analysis.findings.push(`Phishing indicator: ${indicator.description}`);
                    }
                }

                return analysis;
            }

            static analyzeContent(content) {
                const analysis = {
                    content_length: content.length,
                    hasRequiredElements: false,
                    findings: [],
                    legitimacy_score: 0
                };

                const requiredElements = [
                    { name: 'loginfmt', pattern: /name=['"]loginfmt['"]|id=['"]i0116['"]/ },
                    { name: 'idPartnerPL', pattern: /name=['"]idPartnerPL['"]/ },
                    { name: 'urlMsaSignUp', pattern: /urlMsaSignUp/ },
                    { name: 'flowToken', pattern: /flowToken/ }
                ];

                let foundElements = 0;
                for (const element of requiredElements) {
                    if (element.pattern.test(content)) {
                        foundElements++;
                        analysis.findings.push(`Found required element: ${element.name}`);
                    }
                }

                analysis.hasRequiredElements = foundElements >= 2;
                analysis.legitimacy_score = (foundElements / requiredElements.length) * 100;

                return analysis;
            }

            static validateReferrer(referrer) {
                const validReferrers = detectionRules.valid_referrers.referrers;
                return validReferrers.some(validRef => 
                    referrer === validRef || referrer.startsWith(validRef)
                );
            }

            static analyzeForm(formData) {
                const analysis = {
                    isLegitimate: false,
                    findings: [],
                    hasRequiredFields: false
                };

                const requiredFields = ['loginfmt', 'passwd', 'idPartnerPL'];
                let foundFields = 0;

                if (formData.fields) {
                    for (const field of requiredFields) {
                        if (formData.fields.some(f => f.name === field)) {
                            foundFields++;
                            analysis.findings.push(`Found required field: ${field}`);
                        }
                    }
                }

                analysis.hasRequiredFields = foundFields >= 2;
                analysis.isLegitimate = foundFields >= 2;

                return analysis;
            }
        }

        // Test URL analysis
        function testURLs(type) {
            const resultId = `url-${type}-result`;
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing URLs...';

            const testUrls = type === 'legitimate' ? [
                'https://login.microsoftonline.com/common/oauth2/authorize',
                'https://login.microsoftonline.com/tenant/login',
                'https://portal.office.com'
            ] : [
                'https://secure-microsoft-login.com/oauth2/authorize',
                'https://office365-security-update.com/login',
                'https://microsoft-account-verify.net/signin'
            ];

            let results = [];
            for (const url of testUrls) {
                const analysis = SimulatedDetectionEngine.analyzeURL(url);
                results.push({
                    url,
                    analysis,
                    expected: type === 'legitimate',
                    passed: type === 'legitimate' ? analysis.isLegitimate : analysis.threat_level === 'high'
                });
            }

            displayResults(resultDiv, results, 'URL Analysis');
            testResults.push(...results);
            updateSummary();
        }

        // Test content analysis
        function testContentAnalysis() {
            const resultDiv = document.getElementById('content-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing content analysis...';

            const testContent = `
                <form>
                    <input type="email" name="loginfmt" id="i0116">
                    <input type="hidden" name="idPartnerPL" value="test">
                    <input type="password" name="passwd">
                </form>
                <script>
                    var urlMsaSignUp = "https://signup.live.com";
                    var flowToken = "abc123";
                </script>
            `;

            const analysis = SimulatedDetectionEngine.analyzeContent(testContent);
            const result = {
                test: 'Content Analysis',
                analysis,
                passed: analysis.hasRequiredElements,
                expected: true
            };

            displayResults(resultDiv, [result], 'Content Analysis');
            testResults.push(result);
            updateSummary();
        }

        // Test form analysis
        function testFormAnalysis() {
            const resultDiv = document.getElementById('form-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing form analysis...';

            const formData = {
                action: 'https://example.com/auth',
                method: 'POST',
                fields: [
                    { name: 'loginfmt', type: 'email' },
                    { name: 'idPartnerPL', type: 'hidden' },
                    { name: 'passwd', type: 'password' }
                ]
            };

            const analysis = SimulatedDetectionEngine.analyzeForm(formData);
            const result = {
                test: 'Form Analysis',
                analysis,
                passed: analysis.isLegitimate,
                expected: true
            };

            displayResults(resultDiv, [result], 'Form Analysis');
            testResults.push(result);
            updateSummary();
        }

        // Test referrer validation
        function testReferrerValidation() {
            const resultDiv = document.getElementById('referrer-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing referrer validation...';

            const testReferrers = [
                { referrer: 'https://login.microsoftonline.com', expected: true },
                { referrer: 'https://tasks.office.com', expected: true },
                { referrer: 'https://evil-site.com', expected: false },
                { referrer: 'https://fake-microsoft.com', expected: false }
            ];

            let results = [];
            for (const test of testReferrers) {
                const isValid = SimulatedDetectionEngine.validateReferrer(test.referrer);
                results.push({
                    referrer: test.referrer,
                    isValid,
                    expected: test.expected,
                    passed: isValid === test.expected
                });
            }

            displayResults(resultDiv, results, 'Referrer Validation');
            testResults.push(...results);
            updateSummary();
        }

        // Run comprehensive test
        function runComprehensiveTest() {
            const resultDiv = document.getElementById('comprehensive-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Running comprehensive test suite...';

            // Clear previous results
            testResults = [];

            // Run all tests
            testURLs('legitimate');
            testURLs('phishing');
            testContentAnalysis();
            testFormAnalysis();
            testReferrerValidation();

            setTimeout(() => {
                const passed = testResults.filter(r => r.passed).length;
                const total = testResults.length;
                const passRate = Math.round((passed / total) * 100);

                resultDiv.className = passRate >= 80 ? 'test-result success' : 'test-result warning';
                resultDiv.innerHTML = `
                    <h4>Comprehensive Test Completed</h4>
                    <p><strong>Results:</strong> ${passed}/${total} tests passed (${passRate}%)</p>
                    <p><strong>Status:</strong> ${passRate >= 80 ? 'PASS' : 'NEEDS ATTENTION'}</p>
                    <p>Scroll down to see detailed results for each test category.</p>
                `;
            }, 1000);
        }

        // Display test results
        function displayResults(element, results, testType) {
            const passed = results.filter(r => r.passed).length;
            const total = results.length;
            const passRate = Math.round((passed / total) * 100);

            let html = `
                <h4>${testType} Results</h4>
                <p><strong>Pass Rate:</strong> ${passed}/${total} (${passRate}%)</p>
                <div style="margin-top: 10px;">
            `;

            for (const result of results) {
                const status = result.passed ? '‚úì' : '‚úó';
                const statusClass = result.passed ? 'success' : 'error';
                
                html += `
                    <div style="margin: 5px 0; padding: 5px; border-left: 3px solid ${result.passed ? '#28a745' : '#dc3545'};">
                        <span style="font-weight: bold;">${status}</span>
                        ${result.url || result.referrer || result.test || 'Test'}
                        ${result.analysis ? `<br><small>Score: ${result.analysis.legitimacy_score || 'N/A'}%</small>` : ''}
                    </div>
                `;
            }

            html += '</div>';
            element.className = `test-result ${passRate >= 80 ? 'success' : 'warning'}`;
            element.innerHTML = html;
        }

        // Update summary
        function updateSummary() {
            const summaryDiv = document.getElementById('test-summary');
            const contentDiv = document.getElementById('summary-content');
            
            if (testResults.length === 0) return;

            const passed = testResults.filter(r => r.passed).length;
            const failed = testResults.filter(r => r.passed === false).length;
            const total = testResults.length;
            const passRate = Math.round((passed / total) * 100);

            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">${total}</div>
                        <div>Total Tests</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${passed}</div>
                        <div>Passed</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${failed}</div>
                        <div>Failed</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: ${passRate >= 80 ? '#28a745' : '#ffc107'};">${passRate}%</div>
                        <div>Pass Rate</div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <strong>Overall Status: ${passRate >= 80 ? '‚úÖ DETECTION RULES WORKING' : '‚ö†Ô∏è NEEDS ATTENTION'}</strong>
                </div>
            `;

            summaryDiv.style.display = 'block';
        }

        // Check for extension and update banner
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const banner = document.getElementById('statusBanner');
                
                if (typeof window.CyberShieldTesting !== 'undefined') {
                    banner.className = 'status-banner extension-connected';
                    banner.innerHTML = '‚úÖ CyberShield Extension Connected - Live Testing Available';
                } else if (typeof chrome !== 'undefined' && chrome.runtime) {
                    banner.className = 'status-banner extension-connected';
                    banner.innerHTML = 'üîó Extension API Available - Limited Live Testing';
                } else {
                    banner.innerHTML = 'üîç Standalone Mode - Testing Detection Rules Logic (Extension Not Required)';
                }
            }, 1000);
        });
    </script>
</body>
</html>
