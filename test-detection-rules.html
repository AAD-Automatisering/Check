<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection Rules Test Page</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            color: #003049;
            margin-bottom: 15px;
        }
        .test-case {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .test-case h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #F77F00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #E56F00;
        }
        .form-test {
            border: 2px solid #003049;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        input {
            display: block;
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .hidden-content {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Check Detection Rules Test Page</h1>
        <p>This page contains various elements to test the Microsoft 365 Phishing Protection detection rules.</p>

        <!-- Test Section 1: Legitimate Microsoft Form Elements -->
        <div class="test-section">
            <h3>Test 1: Legitimate Microsoft Form Elements</h3>
            <div class="test-case">
                <h4>Microsoft Login Form (Should be detected as legitimate)</h4>
                <div class="form-test">
                    <form id="legitForm" action="https://example.com/auth" method="POST">
                        <input type="email" name="loginfmt" id="i0116" placeholder="Email or Username" required>
                        <input type="hidden" name="idPartnerPL" value="test-partner">
                        <input type="password" name="passwd" placeholder="Password">
                        <button type="button" onclick="testForm('legitForm')">Test Form</button>
                    </form>
                </div>
                <div id="legitForm-result" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Test Section 2: Required Content Detection -->
        <div class="test-section">
            <h3>Test 2: Required Content Detection</h3>
            <div class="test-case">
                <h4>JavaScript Variables (Should be detected)</h4>
                <div class="hidden-content">
                    <script>
                        var urlMsaSignUp = "https://signup.live.com";
                        var flowToken = "abc123-token-xyz";
                        var aadCdnUrl = "https://aadcdn.msauth.net/shared/1.0/content";
                    </script>
                </div>
                <button onclick="testContent()">Test Content Detection</button>
                <div id="content-result" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Test Section 3: Referrer Validation -->
        <div class="test-section">
            <h3>Test 3: Referrer Validation</h3>
            <div class="test-case">
                <h4>Valid Referrer Test</h4>
                <button onclick="testReferrer('https://login.microsoftonline.com')">Test Valid Referrer</button>
                <button onclick="testReferrer('https://evil-site.com')">Test Invalid Referrer</button>
                <div id="referrer-result" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Test Section 4: CSP Header Test -->
        <div class="test-section">
            <h3>Test 4: Content Security Policy</h3>
            <div class="test-case">
                <h4>CSP Header Validation</h4>
                <button onclick="testCSP()">Test CSP Headers</button>
                <div id="csp-result" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Test Section 5: Comprehensive Detection Test -->
        <div class="test-section">
            <h3>Test 5: Comprehensive Detection Engine Test</h3>
            <div class="test-case">
                <h4>Full Detection Engine Validation</h4>
                <button onclick="runComprehensiveTest()">Run Full Test Suite</button>
                <button onclick="validateEngine()">Validate Detection Engine</button>
                <div id="comprehensive-result" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Test Results Summary -->
        <div class="test-section">
            <h3>Test Results Summary</h3>
            <div id="summary-results">
                <p>Click the test buttons above to validate the detection rules.</p>
            </div>
        </div>
    </div>

    <script>
        // Test results storage
        let testResults = [];

        // Test form detection
        async function testForm(formId) {
            const resultDiv = document.getElementById(formId + '-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing form...';

            try {
                const form = document.getElementById(formId);
                const formData = {
                    action: form.action,
                    method: form.method,
                    fields: Array.from(form.elements).map(el => ({
                        name: el.name,
                        type: el.type,
                        value: el.type === 'hidden' ? el.value : ''
                    }))
                };

                // Send message to extension
                const response = await sendMessageToExtension({
                    type: 'TEST_DETECTION_RULES',
                    testData: [{
                        id: 'form_test',
                        description: 'Form element detection test',
                        type: 'form_analysis',
                        input: { formData },
                        expected: { isLegitimate: true }
                    }]
                });

                if (response && response.success) {
                    const result = response.results.testResults[0];
                    displayTestResult(resultDiv, result);
                    testResults.push(result);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = 'Test failed: Extension not responding';
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = 'Test error: ' + error.message;
            }

            updateSummary();
        }

        // Test content detection
        async function testContent() {
            const resultDiv = document.getElementById('content-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing content detection...';

            try {
                const pageContent = document.documentElement.outerHTML;

                const response = await sendMessageToExtension({
                    type: 'TEST_DETECTION_RULES',
                    testData: [{
                        id: 'content_test',
                        description: 'Content detection test',
                        type: 'content_analysis',
                        input: { content: pageContent, context: 'test_page' },
                        expected: { hasRequiredElements: true }
                    }]
                });

                if (response && response.success) {
                    const result = response.results.testResults[0];
                    displayTestResult(resultDiv, result);
                    testResults.push(result);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = 'Test failed: Extension not responding';
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = 'Test error: ' + error.message;
            }

            updateSummary();
        }

        // Test referrer validation
        async function testReferrer(referrer) {
            const resultDiv = document.getElementById('referrer-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing referrer validation...';

            try {
                const response = await sendMessageToExtension({
                    type: 'TEST_DETECTION_RULES',
                    testData: [{
                        id: 'referrer_test',
                        description: 'Referrer validation test',
                        type: 'referrer_check',
                        input: { referrer },
                        expected: { isValid: referrer.includes('microsoftonline.com') || referrer.includes('microsoft.com') }
                    }]
                });

                if (response && response.success) {
                    const result = response.results.testResults[0];
                    displayTestResult(resultDiv, result);
                    testResults.push(result);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = 'Test failed: Extension not responding';
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = 'Test error: ' + error.message;
            }

            updateSummary();
        }

        // Test CSP validation
        async function testCSP() {
            const resultDiv = document.getElementById('csp-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing CSP validation...';

            try {
                const headers = {
                    'content-security-policy-report-only': 'default-src \'self\'; connect-src https://*.msauth.net/ https://*.microsoft.com/ https://*.office.com/'
                };

                const response = await sendMessageToExtension({
                    type: 'TEST_DETECTION_RULES',
                    testData: [{
                        id: 'csp_test',
                        description: 'CSP header validation test',
                        type: 'header_analysis',
                        input: { headers },
                        expected: { csp_valid: true }
                    }]
                });

                if (response && response.success) {
                    const result = response.results.testResults[0];
                    displayTestResult(resultDiv, result);
                    testResults.push(result);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = 'Test failed: Extension not responding';
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = 'Test error: ' + error.message;
            }

            updateSummary();
        }

        // Run comprehensive test
        async function runComprehensiveTest() {
            const resultDiv = document.getElementById('comprehensive-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Running comprehensive test suite...';

            try {
                const response = await sendMessageToExtension({
                    type: 'RUN_COMPREHENSIVE_TEST'
                });

                if (response && response.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `
                        <h4>Comprehensive Test Completed</h4>
                        <p>Test suites run: ${response.tests.testSuites.length}</p>
                        <p>Check the extension popup for detailed results.</p>
                    `;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = 'Comprehensive test failed: Extension not responding';
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = 'Test error: ' + error.message;
            }
        }

        // Validate detection engine
        async function validateEngine() {
            const resultDiv = document.getElementById('comprehensive-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Validating detection engine...';

            try {
                const response = await sendMessageToExtension({
                    type: 'VALIDATE_DETECTION_ENGINE'
                });

                if (response && response.success) {
                    const validation = response.validation;
                    resultDiv.className = validation.engineInitialized ? 'test-result success' : 'test-result error';
                    resultDiv.innerHTML = `
                        <h4>Detection Engine Validation</h4>
                        <p>Engine Status: ${validation.detectionEngineStatus}</p>
                        <p>Initialized: ${validation.engineInitialized ? 'Yes' : 'No'}</p>
                        <p>Check the extension popup for detailed validation results.</p>
                    `;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = 'Engine validation failed: Extension not responding';
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = 'Validation error: ' + error.message;
            }
        }

        // Helper function to send messages to extension
        function sendMessageToExtension(message) {
            return new Promise((resolve, reject) => {
                // Check if Check testing interface is available
                if (typeof window.CheckTesting !== 'undefined') {
                    window.CheckTesting.sendMessage(message)
                        .then(resolve)
                        .catch(reject);
                } else {
                    // Fallback: Try direct chrome API (if available)
                    if (typeof chrome !== 'undefined' && chrome.runtime) {
                        chrome.runtime.sendMessage(message, (response) => {
                            if (chrome.runtime.lastError) {
                                reject(new Error(chrome.runtime.lastError.message));
                            } else {
                                resolve(response);
                            }
                        });
                    } else {
                        reject(new Error('Check extension not detected. Please ensure the extension is installed and this page is loaded with the extension active.'));
                    }
                }
            });
        }

        // Display individual test result
        function displayTestResult(element, result) {
            const statusClass = result.status === 'passed' ? 'success' : 'error';
            element.className = `test-result ${statusClass}`;
            element.innerHTML = `
                <h4>Test: ${result.description}</h4>
                <p>Status: ${result.status}</p>
                <p>Message: ${result.message}</p>
                ${result.actual ? `<p>Result: ${JSON.stringify(result.actual, null, 2)}</p>` : ''}
            `;
        }

        // Update test summary
        function updateSummary() {
            const summaryDiv = document.getElementById('summary-results');
            const passed = testResults.filter(r => r.status === 'passed').length;
            const failed = testResults.filter(r => r.status === 'failed').length;
            const total = testResults.length;

            summaryDiv.innerHTML = `
                <h4>Test Summary</h4>
                <p>Total Tests: ${total}</p>
                <p>Passed: <span class="success">${passed}</span></p>
                <p>Failed: <span class="error">${failed}</span></p>
                <p>Pass Rate: ${total > 0 ? Math.round((passed / total) * 100) : 0}%</p>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Detection Rules Test Page Loaded');

            // Check if extension is available
            setTimeout(() => {
                checkExtensionAvailability();
            }, 1000); // Give time for content script to inject
        });

        function checkExtensionAvailability() {
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                border-radius: 6px;
                font-weight: bold;
                z-index: 10000;
                font-size: 12px;
            `;

            if (typeof window.CheckTesting !== 'undefined') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.textContent = '✓ Check Extension Connected';

                // Test connection
                window.CheckTesting.sendMessage({
                    type: 'GET_CONFIG'
                }).then(() => {
                    statusDiv.textContent = '✓ Check Extension Ready';
                }).catch(() => {
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.style.border = '1px solid #ffeaa7';
                    statusDiv.textContent = '⚠ Extension Connected but Not Responding';
                });
            } else if (typeof chrome !== 'undefined' && chrome.runtime) {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.border = '1px solid #ffeaa7';
                statusDiv.textContent = '⚠ Extension API Available (Limited)';
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
                statusDiv.textContent = '✗ Check Extension Not Detected';
            }

            document.body.appendChild(statusDiv);

            // Remove status after 5 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
