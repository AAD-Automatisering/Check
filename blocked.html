<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Access Blocked - Check</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Gilroy", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #f77f00 0%, #003049 100%);
        color: #003049;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 16px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .icon {
        width: 80px;
        height: 80px;
        background: #f77f00;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 30px;
        font-size: 40px;
        color: white;
      }

      h1 {
        font-size: 32px;
        font-weight: 600;
        color: #f77f00;
        margin-bottom: 16px;
      }

      .subtitle {
        font-size: 18px;
        color: #6b7280;
        margin-bottom: 30px;
        line-height: 1.5;
      }

      .reason {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: left;
      }

      .reason-title {
        font-weight: 600;
        color: #991b1b;
        margin-bottom: 8px;
      }

      .reason-text {
        color: #7f1d1d;
        line-height: 1.5;
      }

      .actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        border: none;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .btn-primary {
        background: #f77f00;
        color: white;
      }

      .btn-primary:hover {
        background: #e56f00;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .details {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
        text-align: left;
      }

      .details-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
      }

      .details-list {
        list-style: none;
        font-size: 14px;
        color: #6b7280;
      }

      .details-list li {
        padding: 4px 0;
        display: flex;
        justify-content: space-between;
      }

      .footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
        font-size: 12px;
        color: #9ca3af;
      }

      .company-logo {
        max-width: 120px;
        height: auto;
        margin-bottom: 20px;
      }

      @media (max-width: 480px) {
        .container {
          padding: 30px 20px;
        }

        h1 {
          font-size: 24px;
        }

        .subtitle {
          font-size: 16px;
        }

        .actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="icon material-icons">security</div>

      <h1>Access Blocked</h1>
      <p class="subtitle">
        This website has been blocked by your organization's security policy
      </p>

      <div class="reason">
        <div class="reason-title">Reason for blocking:</div>
        <div class="reason-text" id="blockReason">
          This website looks like it has tried to steal your login credentials,
          to prevent you from logging in we've blocked access.
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="goBackBtn">Go Back</button>
        <button class="btn btn-secondary" id="contactAdminBtn">
          Contact Admin
        </button>
      </div>

      <div class="details">
        <div class="details-title">Block Details</div>
        <ul class="details-list">
          <li>
            <span>URL:</span>
            <span id="blockedUrl">--</span>
          </li>
          <li>
            <span>Category:</span>
            <span id="threatCategory">Security Threat</span>
          </li>
        </ul>
      </div>

      <div class="footer">
        <div id="companyBranding">
          Protected by <strong id="companyName">Check</strong>
        </div>
        <div style="margin-top: 8px">
          For support, contact your IT administrator
        </div>
      </div>
    </div>

    <script>
      // Parse URL parameters to get block details
      function parseUrlParams() {
        console.log("parseUrlParams called");
        console.log("Current URL:", window.location.href);
        
        const urlParams = new URLSearchParams(window.location.search);
        console.log("URL params:", urlParams.toString());
        console.log("All URL params:");
        for (const [key, value] of urlParams.entries()) {
          console.log(`  ${key}: ${value}`);
        }

        // Parse details from the new format
        const detailsParam = urlParams.get("details");
        console.log("Details param:", detailsParam);
        
        if (detailsParam) {
          try {
            const details = JSON.parse(decodeURIComponent(detailsParam));
            console.log("Parsed details:", details);
            
            // Update blocked URL with defanging
            if (details.url) {
              console.log("Setting blocked URL to:", details.url);
              const defangedUrl = defangUrl(details.url);
              console.log("Defanged URL:", defangedUrl);
              document.getElementById("blockedUrl").textContent = defangedUrl;
            } else {
              console.log("No URL in details, checking for original URL");
              // Try to get the original URL from the referrer or other sources
              const fallbackUrl = document.referrer || "Unknown URL";
              console.log("Using fallback URL:", fallbackUrl);
              document.getElementById("blockedUrl").textContent = defangUrl(fallbackUrl);
            }
            
            // Update block reason
            if (details.reason) {
              console.log("Setting block reason to:", details.reason);
              document.getElementById("blockReason").textContent = details.reason;
            }
            
            // Update threat category based on rule or score
            if (details.rule) {
              document.getElementById("threatCategory").textContent = `Rule: ${details.rule}`;
            } else if (details.score !== undefined) {
              document.getElementById("threatCategory").textContent = `Score: ${details.score}/${details.threshold}`;
            }
            
          } catch (error) {
            console.warn("Failed to parse block details:", error);
            console.log("Error details:", error.message);
            // Fallback to legacy URL parsing
            const blockedUrl = urlParams.get("url") || document.referrer || "Unknown URL";
            console.log("Using fallback URL:", blockedUrl);
            document.getElementById("blockedUrl").textContent = defangUrl(blockedUrl);
          }
        } else {
          console.log("No details param, using legacy parsing");
          // Legacy URL parsing for backward compatibility
          const blockedUrl = urlParams.get("url") || document.referrer || "Unknown URL";
          console.log("Legacy blocked URL:", blockedUrl);
          document.getElementById("blockedUrl").textContent = defangUrl(blockedUrl);
          
          const reason = urlParams.get("reason");
          if (reason) {
            console.log("Legacy reason:", reason);
            document.getElementById("blockReason").textContent = decodeURIComponent(reason);
          }
        }
        
        console.log("Final blocked URL element text:", document.getElementById("blockedUrl").textContent);
      }

      function defangUrl(url) {
        if (!url || url === "about:blank" || url.includes("chrome-extension://")) {
          return "Unknown URL";
        }
        
        // Defang the URL by replacing dangerous characters
        let defanged = url
          .replace(/\./g, "[.]")  // Replace dots
          .replace(/:/g, "[:]")   // Replace colons
          .replace(/\//g, "[/]"); // Replace slashes
        
        // Truncate if too long
        if (defanged.length > 60) {
          defanged = defanged.substring(0, 57) + "...";
        }
        
        return defanged;
      }

      function truncateUrl(url) {
        if (url.length > 50) {
          return url.substring(0, 47) + "...";
        }
        return url;
      }

      function goBack() {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = "about:blank";
        }
      }

      function reportIssue() {
        const subject = encodeURIComponent("Check - False Positive Report");
        const body = encodeURIComponent(`
Blocked URL: ${document.getElementById("blockedUrl").textContent}
Block Reason: ${document.getElementById("blockReason").textContent}
Time: ${document.getElementById("blockTime").textContent}

I believe this website was incorrectly blocked. Please review.

Additional details:
[Please provide any additional context about why you believe this is a false positive]
            `);

        window.location.href = `mailto:support@check.com?subject=${subject}&body=${body}`;
      }

      function contactAdmin() {
        console.log("contactAdmin function called");
        
        // Try to get support email from storage, with fallback
        try {
          if (typeof chrome !== "undefined" && chrome.storage && chrome.storage.local) {
            chrome.storage.local.get(['brandingConfig'], (result) => {
              console.log("Storage result:", result);
              const supportEmail = result.brandingConfig?.supportEmail || 'support@cyberdrain.com';
              console.log("Using support email:", supportEmail);
              openMailto(supportEmail);
            });
          } else {
            console.log("Chrome storage not available, using default email");
            openMailto('support@cyberdrain.com');
          }
        } catch (error) {
          console.error("Error accessing storage:", error);
          openMailto('support@cyberdrain.com');
        }
      }
      
      function openMailto(supportEmail) {
        const blockedUrl = document.getElementById("blockedUrl").textContent;
        const reason = document.getElementById("blockReason").textContent;
        
        // Create subject with defanged URL
        const subject = encodeURIComponent(`Blocked page: ${blockedUrl}`);
        
        const body = encodeURIComponent(`I am requesting access to a website that was blocked by Microsoft 365 Protection.

Blocked URL: ${blockedUrl}
Block Reason: ${reason}
Time: ${new Date().toLocaleString()}

I believe this website should be accessible for business purposes. Please review and whitelist if appropriate.

Additional context:
[Please provide any additional business justification]`);
        
        const mailtoUrl = `mailto:${supportEmail}?subject=${subject}&body=${body}`;
        console.log("Opening mailto URL:", mailtoUrl);
        
        try {
          window.location.href = mailtoUrl;
        } catch (error) {
          console.error("Error opening mailto:", error);
          // Fallback: try using window.open
          try {
            window.open(mailtoUrl);
          } catch (openError) {
            console.error("Error with window.open:", openError);
            alert(`Please contact your IT administrator at: ${supportEmail}`);
          }
        }
      }

      // Load branding configuration
      async function loadBranding() {
        try {
          // Load branding from extension storage
          chrome.storage.local.get(['brandingConfig'], (result) => {
            const branding = result.brandingConfig || {};
            
            // Update company name with fallback to "Check"
            const companyName = branding.companyName || "Check";
            document.getElementById("companyName").textContent = companyName;
            document.title = `Access Blocked - ${companyName}`;
            
            // Update product name if available
            if (branding.productName) {
              document.querySelector('h1').textContent = `Access Blocked by ${branding.productName}`;
            }
            
            // Update primary color if available
            if (branding.primaryColor) {
              document.documentElement.style.setProperty('--primary-color', branding.primaryColor);
              // Update CSS custom property
              const style = document.createElement('style');
              style.textContent = `
                .icon { background: ${branding.primaryColor} !important; }
                h1 { color: ${branding.primaryColor} !important; }
                .btn-primary { background: ${branding.primaryColor} !important; }
                .btn-primary:hover { background: ${branding.primaryColor}dd !important; }
              `;
              document.head.appendChild(style);
            }
          });
          
          // Also try to load from branding.json as fallback
          try {
            const response = await fetch(chrome.runtime.getURL("config/branding.json"));
            if (response.ok) {
              const brandingConfig = await response.json();
              
              // Only update if not already set from storage
              if (!document.getElementById("companyName").textContent ||
                  document.getElementById("companyName").textContent === "Check") {
                document.getElementById("companyName").textContent = brandingConfig.companyName || "Check";
                document.title = `Access Blocked - ${brandingConfig.companyName || "Check"}`;
              }
            }
          } catch (fetchError) {
            console.warn("Could not load branding.json:", fetchError);
          }
          
        } catch (error) {
          console.warn("Could not load branding configuration:", error);
          // Use defaults
          document.getElementById("companyName").textContent = "Check";
          document.title = "Access Blocked - Check";
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, initializing page");
        
        // Add event listeners for buttons (CSP compliant)
        document.getElementById("goBackBtn").addEventListener("click", goBack);
        document.getElementById("contactAdminBtn").addEventListener("click", contactAdmin);
        
        // Parse URL parameters and load branding
        parseUrlParams();
        loadBranding();
        
        // Debug: Check if URL was set properly
        setTimeout(() => {
          console.log("After 1 second - URL element:", document.getElementById("blockedUrl").textContent);
        }, 1000);
      });

      // Handle keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        // ESC key to go back
        if (e.key === "Escape") {
          goBack();
        }
        // Ctrl+R or F5 to go back (prevent refresh on blocked page)
        if ((e.ctrlKey && e.key === "r") || e.key === "F5") {
          e.preventDefault();
          goBack();
        }
      });

      // Prevent right-click context menu on blocked page
      document.addEventListener("contextmenu", (e) => {
        e.preventDefault();
      });

      // Log page view for analytics
      if (typeof chrome !== "undefined" && chrome.runtime) {
        chrome.runtime.sendMessage({
          type: "LOG_EVENT",
          event: {
            type: "blocked_page_viewed",
            url: new URLSearchParams(window.location.search).get("url"),
            timestamp: new Date().toISOString(),
          },
        });
      }
    </script>
  </body>
</html>
